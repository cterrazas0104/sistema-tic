<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - SEDIF</title>
    <style>
        :root { --primary: #2c3e50; --accent: #00ad9f; --bg: #f4f7f6; --warning: #e67e22; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 20px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; margin-top: 20px; }
        .btn { display: block; background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-decoration: none; font-weight: bold; text-align: center; transition: 0.3s; font-size: 0.85em; border: none; }
        .btn-main { background: var(--warning); color: white; border: 2px solid #d35400; } 
        .btn-accent { background: var(--accent); }
        .btn-ecala { background: #8e44ad; } 
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .section-title { grid-column: 1 / -1; margin-top: 30px; color: #7f8c8d; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; border-left: 4px solid var(--accent); padding-left: 10px; }
        .monitor-container { margin-top: 30px; overflow-x: auto; background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: #f8f9fa; padding: 12px; text-align: left; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn-re { background: var(--warning); color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.75em; font-weight: bold; }
        .logout-container { margin-top: 50px; text-align: center; }
        .btn-logout { background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Panel de Control Administrador</h2>
        
        <div class="grid">
            <div class="section-title">Gesti√≥n de Tickets y Operaci√≥n</div>
            <a href="pendientes.html" class="btn btn-main">üì© Tickets Pendientes de Asignaci√≥n</a>
            <a href="ibreves.html" class="btn btn-ecala">üìù Nueva Incidencia Express</a>
            <a href="validacion.html" class="btn" style="background: #9b59b6; border: 2px solid #8e44ad;">‚úÖ Tickets por Validar (Jefe)</a>
            <a href="https://docs.google.com/spreadsheets/d/1I1cTeHiKZ3y2AFmNpZoh1QLQQRX-mwv6PQlxpfXD-nA/edit?gid=0#gid=0" target="_blank" class="btn btn-accent">üìä Base de Datos Completa (Excel)</a>
            
            <div class="section-title">Monitoreo de Tickets Asignados (Reasignaci√≥n)</div>
            <div class="monitor-container" style="grid-column: 1 / -1;">
                <table>
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th>T√©cnico / Equipo Actual</th>
                            <th>Usuario</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-body">
                        <tr><td colspan="4" style="text-align:center; padding:20px;">Cargando tickets activos...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">Historiales Individuales</div>
            <a href="historial.html?nombre=Mtr. Gabriel Terrazas" class="btn">üìã Gabriel Terrazas</a>
            <a href="historial.html?nombre=Lic. Miguel Chavez" class="btn">üìã Miguel Chavez</a>
            <a href="historial.html?nombre=Lic. Eduardo Perez" class="btn">üìã Eduardo Perez</a>
            <a href="historial.html?nombre=Lic. Martin Alejandro Reyes Bocanegra" class="btn">üìã Alejandro Reyes</a>
            <a href="historial.html?nombre=Fati" class="btn">üìã Fati</a>
            <a href="historial.html?nombre=Lic. Luis Carlos" class="btn">üìã Luis Carlos</a>

            <div class="section-title">Equipos: Gabriel, Miguel, Eduardo y Alejandro</div>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Eduardo" class="btn">üë• Gabriel - Eduardo</a>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Miguel" class="btn">üë• Gabriel - Miguel</a>
            <a href="historial.html?nombre=Lic. Miguel - Lic. Eduardo" class="btn">üë• Miguel - Eduardo</a>
            <a href="historial.html?nombre=Lic. Eduardo - Lic. Alejandro" class="btn">üë• Eduardo - Alejandro</a>
            <a href="historial.html?nombre=Lic. Miguel - Lic. Alejandro" class="btn">üë• Miguel - Alejandro</a>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Alejandro" class="btn">üë• Gabriel - Alejandro</a>

            <div class="section-title">Nuevos Equipos con Luis Carlos</div>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Alejandro" class="btn">üë• Luis Carlos - Alejandro</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Eduardo" class="btn">üë• Luis Carlos - Eduardo</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Miguel" class="btn">üë• Luis Carlos - Miguel</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Mtr. Gabriel" class="btn">üë• Luis Carlos - Gabriel</a>
        </div>

        <div class="logout-container">
            <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n de Administrador</button>
        </div>
    </div>

   <script>
        // NUEVA SEGURIDAD RBAC: Solo Admin puede estar aqu√≠
        if(localStorage.getItem('userRole') !== 'admin') { 
            window.location.href = "index.html"; 
        }
        
        function logout() { 
            if(confirm("¬øEst√°s seguro de cerrar sesi√≥n de Administrador?")) { 
                localStorage.clear(); 
                window.location.href = "index.html"; 
            } 
        }

        // --- (AQU√ç DEBAJO SIGUE TU C√ìDIGO NORMAL DEL MONITOR) ---
        const diccionarioTecnicos = {
            "1": "Mtr. Gabriel Terrazas", "2": "Lic. Miguel Chavez", "3": "Lic. Eduardo Perez",
            "4": "Lic. Martin Alejandro Reyes Bocanegra", "5": "Fati", "6": "Mtr. Gabriel - Lic. Eduardo",
            "7": "Mtr. Gabriel - Lic. Miguel", "8": "Lic. Miguel - Lic. Eduardo", "9": "Lic. Eduardo - Lic. Alejandro",
            "10": "Lic. Miguel - Lic. Alejandro", "11": "Mtr. Gabriel - Lic. Alejandro", "12": "Lic. Luis Carlos",
            "13": "Lic. Luis Carlos - Lic. Alejandro", "14": "Lic. Luis Carlos - Lic. Eduardo",
            "15": "Lic. Luis Carlos - Lic. Miguel", "16": "Lic. Luis Carlos - Mtr. Gabriel"
        };

        async function cargarMonitor() {
            const webhookURL = 'https://hook.us2.make.com/g2o6bagpnddob1127nhxqpwc7t6sdadx?nombre=MONITOR'; 
            try {
                const res = await fetch(webhookURL);
                const rawData = await res.text(); 
                const data = JSON.parse(rawData.trim()); 
                
                const body = document.getElementById('monitor-body');
                body.innerHTML = "";

                if (!data || !Array.isArray(data) || data.length === 0) {
                    body.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>No hay tickets asignados recientemente.</td></tr>";
                    return;
                }

                let totalHtml = "";
                data.forEach(t => {
                    const tid = t.id || t.ID || t.idticket || 'S/N';
                    const tuser = t.usuario || t.Usuario || 'N/A';
                    const tprob = t.problema || t.Problema || '';
                    const ttec_id = String(t.tecnico || t.Tecnico || '9');
                    
                    const nombreParaTabla = diccionarioTecnicos[ttec_id] || ttec_id;

                    totalHtml += `
                        <tr>
                            <td><b>#${tid}</b></td>
                            <td><span style="color:#2c3e50; font-weight:bold;">${nombreParaTabla}</span></td>
                            <td>${tuser}</td>
                            <td>
                                <a href="reasignar.html?id=${tid}&nombreActual=${encodeURIComponent(ttec_id)}&user=${encodeURIComponent(tuser)}&prob=${encodeURIComponent(tprob)}" 
                                   class="btn-re">REASIGNAR</a>
                            </td>
                        </tr>`;
                });
                body.innerHTML = totalHtml;

            } catch (e) { 
                console.error("Error cargando monitor:", e);
                document.getElementById('monitor-body').innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Error de datos. Revisa la consola (F12).</td></tr>"; 
            }
        }
        
        cargarMonitor();
    </script>
</body>
</html>
