<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - SEDIF</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #00ad9f; --bg: #f4f7f6; --warning: #e67e22; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        
        /* DASHBOARD KPIs */
        .kpi-container { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi-card { flex: 1; min-width: 150px; padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.3s;}
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-card h3 { margin: 0; font-size: 2.5em; }
        .kpi-card p { margin: 5px 0 0 0; font-weight: bold; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;}
        .bg-red { background: linear-gradient(135deg, #ff6b6b, #e74c3c); }
        .bg-blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .bg-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }

        /* GR√ÅFICO Y TABLA */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-bottom: 40px; }
        .chart-box { background: #fdfdfd; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .monitor-container { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; overflow-y: auto; max-height: 400px;}
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: #f8f9fa; padding: 10px; text-align: left; color: #666; position: sticky; top: 0; z-index: 1;}
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .btn-re { background: var(--warning); color: white; padding: 6px 10px; border-radius: 6px; text-decoration: none; font-size: 0.8em; font-weight: bold; }

        /* BOTONES DE SECCIONES */
        .section-title { grid-column: 1 / -1; margin-top: 10px; color: #7f8c8d; font-size: 0.9em; text-transform: uppercase; font-weight: bold; border-left: 4px solid var(--accent); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .btn { display: block; background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-decoration: none; font-weight: bold; text-align: center; transition: 0.3s; font-size: 0.85em; }
        .btn-main { background: var(--warning); border: 2px solid #d35400; } 
        .btn-accent { background: var(--accent); }
        .btn-ecala { background: #8e44ad; } 
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .logout-container { margin-top: 40px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;}
        .btn-logout { background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold; text-decoration: underline; font-size: 1em;}

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>
            <span>Cuarto de Mando TIC</span>
            <span style="font-size: 0.6em; color: #7f8c8d; font-weight: normal;">Hola, Jefe</span>
        </h2>

        <div class="kpi-container" id="kpi-zone">
            <div class="kpi-card bg-red">
                <h3 id="kpi-pendientes">--</h3>
                <p>Sin Asignar</p>
            </div>
            <div class="kpi-card bg-blue">
                <h3 id="kpi-atendiendo">--</h3>
                <p>En Proceso</p>
            </div>
            <div class="kpi-card bg-purple">
                <h3 id="kpi-revision">--</h3>
                <p>Por Validar</p>
            </div>
            <div class="kpi-card bg-green">
                <h3 id="kpi-concluidos">--</h3>
                <p>Concluidos</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-box">
                <h4 style="margin-top:0; color:var(--primary); text-align:center;">Carga de Trabajo Activa</h4>
                <canvas id="miGrafico"></canvas>
            </div>
            
            <div class="monitor-container">
                <h4 style="margin-top:0; color:var(--primary);">Radar de Tickets Asignados</h4>
                <table>
                    <thead>
                        <tr><th>Ticket</th><th>T√©cnico/Equipo</th><th>Usuario</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="monitor-body">
                        <tr><td colspan="4" style="text-align:center;">Cargando datos en tiempo real...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid">
            <div class="section-title">Operaci√≥n Diaria</div>
            <a href="pendientes.html" class="btn btn-main">üì© Pendientes de Asignaci√≥n</a>
            <a href="ibreves.html" class="btn btn-ecala">üìù Registrar Incidencia Express</a>
            <a href="validacion.html" class="btn" style="background: #9b59b6; border: 2px solid #8e44ad;">‚úÖ Tickets por Validar</a>
            <a href="https://docs.google.com/spreadsheets/d/1I1cTeHiKZ3y2AFmNpZoh1QLQQRX-mwv6PQlxpfXD-nA/edit?gid=0#gid=0" target="_blank" class="btn btn-accent">üìä Base de Datos Completa</a>
            
            <div class="section-title">Bandejas Individuales</div>
            <a href="historial.html?nombre=Mtr. Gabriel Terrazas" class="btn">üìã Gabriel Terrazas</a>
            <a href="historial.html?nombre=Lic. Miguel Chavez" class="btn">üìã Miguel Chavez</a>
            <a href="historial.html?nombre=Lic. Eduardo Perez" class="btn">üìã Eduardo Perez</a>
            <a href="historial.html?nombre=Lic. Martin Alejandro Reyes Bocanegra" class="btn">üìã Alejandro Reyes</a>
            <a href="historial.html?nombre=Fati" class="btn">üìã Fati</a>
            <a href="historial.html?nombre=Lic. Luis Carlos" class="btn">üìã Luis Carlos</a>

            <div class="section-title">Bandejas de Equipos y Parejas</div>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Eduardo" class="btn">üë• Gabriel - Eduardo</a>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Miguel" class="btn">üë• Gabriel - Miguel</a>
            <a href="historial.html?nombre=Lic. Miguel - Lic. Eduardo" class="btn">üë• Miguel - Eduardo</a>
            <a href="historial.html?nombre=Lic. Eduardo - Lic. Alejandro" class="btn">üë• Eduardo - Alejandro</a>
            <a href="historial.html?nombre=Lic. Miguel - Lic. Alejandro" class="btn">üë• Miguel - Alejandro</a>
            <a href="historial.html?nombre=Mtr. Gabriel - Lic. Alejandro" class="btn">üë• Gabriel - Alejandro</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Alejandro" class="btn">üë• Luis Carlos - Alejandro</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Eduardo" class="btn">üë• Luis Carlos - Eduardo</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Lic. Miguel" class="btn">üë• Luis Carlos - Miguel</a>
            <a href="historial.html?nombre=Lic. Luis Carlos - Mtr. Gabriel" class="btn">üë• Luis Carlos - Gabriel</a>
        </div>

        <div class="logout-container">
            <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n de Administrador</button>
        </div>
    </div>

    <script>
        // SEGURIDAD RBAC
        if(localStorage.getItem('userRole') !== 'admin') { window.location.href = "index.html"; }
        
        function logout() { 
            if(confirm("¬øEst√°s seguro de salir del panel?")) { 
                localStorage.clear(); 
                window.location.href = "index.html"; 
            } 
        }

        const diccionarioTecnicos = {
            "1": "Mtr. Gabriel Terrazas", "2": "Lic. Miguel Chavez", "3": "Lic. Eduardo Perez",
            "4": "Lic. Alejandro Reyes", "5": "Fati", "6": "Mtr. Gabriel - Lic. Eduardo",
            "7": "Mtr. Gabriel - Lic. Miguel", "8": "Lic. Miguel - Lic. Eduardo", "9": "Lic. Eduardo - Lic. Alejandro",
            "10": "Lic. Miguel - Lic. Alejandro", "11": "Mtr. Gabriel - Lic. Alejandro", "12": "Lic. Luis Carlos",
            "13": "Luis Carlos - Alejandro", "14": "Luis Carlos - Eduardo",
            "15": "Luis Carlos - Miguel", "16": "Luis Carlos - Mtr. Gabriel"
        };

        // üëá LA URL DE TU APPS SCRIPT üëá
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxZhLFw530NGYRXyvdJLoMw0Y40VijyHqW0dwnkEv6Id68GiB__W77WEPYoaliusost/exec';

        let miGrafico; // Variable global para el gr√°fico

        async function cargarDashboard() {
            try {
                const res = await fetch(`${scriptURL}?accion=dashboard&t=${new Date().getTime()}`);
                const data = await res.json();
                
                // 1. LLENAR LOS KPIs
                document.getElementById('kpi-pendientes').innerText = data.pendientes;
                document.getElementById('kpi-atendiendo').innerText = data.atendiendo;
                document.getElementById('kpi-revision').innerText = data.revision;
                document.getElementById('kpi-concluidos').innerText = data.concluidos;

                // 2. LLENAR LA TABLA DEL MONITOR
                const body = document.getElementById('monitor-body');
                body.innerHTML = "";
                if (!data.activos || data.activos.length === 0) {
                    body.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:green; font-weight:bold;'>üéâ No hay carga activa asignada.</td></tr>";
                } else {
                    let htmlTabla = "";
                    data.activos.forEach(t => {
                        const nombreLimpio = diccionarioTecnicos[t.tecnico] || t.tecnico;
                        htmlTabla += `
                            <tr>
                                <td><b>#${t.id}</b></td>
                                <td style="color:#2980b9; font-weight:bold;">${nombreLimpio}</td>
                                <td>${t.usuario}</td>
                                <td><a href="reasignar.html?id=${t.id}&nombreActual=${encodeURIComponent(t.tecnico)}&user=${encodeURIComponent(t.usuario)}&prob=${encodeURIComponent(t.problema)}" class="btn-re">Reasignar</a></td>
                            </tr>`;
                    });
                    body.innerHTML = htmlTabla;
                }

                // 3. RENDERIZAR EL GR√ÅFICO (Top 5 con m√°s carga)
                const ctx = document.getElementById('miGrafico').getContext('2d');
                
                // Preparar datos para el gr√°fico
                let labelsCarga = [];
                let datosCarga = [];
                
                for (const [id, count] of Object.entries(data.porTecnico)) {
                    labelsCarga.push(diccionarioTecnicos[id] || id);
                    datosCarga.push(count);
                }

                if(miGrafico) miGrafico.destroy(); // Destruir gr√°fico viejo si se recarga
                
                miGrafico = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labelsCarga,
                        datasets: [{
                            label: 'Tickets Asignados',
                            data: datosCarga,
                            backgroundColor: '#3498db',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

            } catch (e) { 
                console.error("Error cargando Dashboard:", e);
                document.getElementById('monitor-body').innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Error de datos.</td></tr>"; 
            }
        }
        
        // Iniciar todo
        cargarDashboard();
    </script>
</body>
</html>
