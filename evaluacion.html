<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n TIC SEDIF</title>
    <style>
        :root { --primary: #00ad9f; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; box-sizing: border-box; }
        h2 { color: var(--primary); font-size: 1.3em; margin-bottom: 20px; }
        .emoji-group { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px; }
        .emoji-btn { flex: 1; border: 2px solid #eee; border-radius: 12px; padding: 10px 2px; cursor: pointer; transition: 0.2s; background: white; }
        .emoji-btn:hover { border-color: var(--primary); }
        .emoji-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .emoji-btn span { display: block; font-size: 24px; margin-bottom: 4px; }
        .emoji-btn small { font-size: 9px; font-weight: bold; text-transform: uppercase; display: block; }
        textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; margin-top: 10px; resize: none; }
        #btn-enviar { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1em; }
        #btn-enviar:disabled { background: #ccc; }
        #exito, #ya-calificado, #cargando { display: none; }
    </style>
</head>
<body>
    <div id="cargando" class="card"><h2>‚åõ</h2><p>Verificando ticket...</p></div>

    <div id="form-container" class="card" style="display:none;">
        <h2>Tu opini√≥n nos ayuda</h2>
        <div class="question" style="text-align: left;">
            <label style="font-weight: 600; color: #444; font-size: 0.95em;">¬øC√≥mo calificar√≠as la atenci√≥n de <span id="nombre-tecnico" style="color:#00ad9f; font-weight:bold;"></span>?</label>
            <div class="emoji-group" id="q1" style="margin-top: 15px;">
                <div class="emoji-btn" onclick="select(this, 'q1', 'Excelente')"><span>üòç</span><small>Exc.</small></div>
                <div class="emoji-btn" onclick="select(this, 'q1', 'Bueno')"><span>üôÇ</span><small>Bien</small></div>
                <div class="emoji-btn" onclick="select(this, 'q1', 'Neutral')"><span>üòê</span><small>Reg.</small></div>
                <div class="emoji-btn" onclick="select(this, 'q1', 'Malo')"><span>üôÅ</span><small>Mal</small></div>
                <div class="emoji-btn" onclick="select(this, 'q1', 'P√©simo')"><span>üò°</span><small>P√©s.</small></div>
            </div>
        </div>
        <textarea id="comentarios" rows="3" placeholder="Comentarios adicionales..."></textarea>
        <button id="btn-enviar" onclick="enviar()">Enviar Evaluaci√≥n</button>
    </div>

    <div id="exito" class="card"><h2>‚úÖ</h2><h2>¬°Gracias!</h2><p>Tu respuesta ha sido registrada.</p></div>
    <div id="ya-calificado" class="card"><h2>‚úã</h2><h2>Acceso Restringido</h2><p>Este ticket ya fue evaluado o est√° cerrado.</p></div>

    <script>
        // OFUSCACI√ìN DE SEGURIDAD
        const _u = "https://hook.us2.make.com/";
        const _p1 = "g2o6bagpnddob1127nhxqpwc7t6sdadx"; // Webhook Consulta
        const _p2 = "fpndkbyluum7qzuh5l3z15s6xq9fli21"; // Webhook Env√≠o

        const params = new URLSearchParams(window.location.search);
        const ticketId = params.get('ticket') || 'Sin ID';
        const tecnico = (params.get('tecnico') || "nuestro personal").replace(/_/g, ' ');
        document.getElementById('nombre-tecnico').innerText = tecnico;

        async function verificar() {
            document.getElementById('cargando').style.display = 'block';
            try {
                // Consulta al Excel v√≠a Make
                const res = await fetch(`${_u}${_p1}?nombre=${encodeURIComponent(tecnico)}`);
                const texto = await res.text();
                const data = texto.toLowerCase();
                
                // BLOQUEO SI: Aparece el ID del ticket + "Concluido"/"Evaluado" O si ya se vot√≥ en este dispositivo
                if ((data.includes(ticketId.toLowerCase()) && (data.includes("concluido") || data.includes("evaluado"))) || 
                    localStorage.getItem('calificado_' + ticketId)) {
                    document.getElementById('cargando').style.display = 'none';
                    document.getElementById('ya-calificado').style.display = 'block';
                } else {
                    document.getElementById('cargando').style.display = 'none';
                    document.getElementById('form-container').style.display = 'block';
                }
            } catch (e) {
                // Si falla la red, al menos revisamos el bloqueo del dispositivo
                document.getElementById('cargando').style.display = 'none';
                if (localStorage.getItem('calificado_' + ticketId)) {
                    document.getElementById('ya-calificado').style.display = 'block';
                } else {
                    document.getElementById('form-container').style.display = 'block';
                }
            }
        }
        verificar();

        let val = '';
        function select(el, group, score) {
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            val = score;
        }

        async function enviar() {
            if(!val) return alert("Por favor selecciona un emoji.");
            const btn = document.getElementById('btn-enviar');
            btn.disabled = true;
            btn.innerText = "Enviando...";
            
            try {
                await fetch(`${_u}${_p2}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket: ticketId,
                        tecnico: tecnico,
                        profesionalismo: val,
                        rapidez: val,
                        solucion_encuesta: val,
                        comentarios: document.getElementById('comentarios').value,
                        accion: "EvaluacionFinalizada"
                    })
                });
                
                // Guardamos el bloqueo local
                localStorage.setItem('calificado_' + ticketId, 'true');
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('exito').style.display = 'block';
            } catch (e) {
                alert("Error al enviar. Intenta de nuevo.");
                btn.disabled = false;
                btn.innerText = "Enviar Evaluaci√≥n";
            }
        }
    </script>
</body>
</html>
