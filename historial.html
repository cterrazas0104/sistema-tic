<!DOCTYPE html>
<html lang="es">
<head>
    <script>
        // SEGURIDAD: Verifica si pasó por el login
        if (sessionStorage.getItem('sesion_tic') !== 'activa') {
            window.location.href = 'index.html';
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TIC</title>
    <style>
        :root { --primary: #00ad9f; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #f8f9fa; color: #666; text-transform: uppercase; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: top; }
        .btn-resolver { background: var(--primary); color: white; padding: 8px 15px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 12px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-concluido { background: #e6fcf5; color: #099268; }
        .badge-revision { background: #fff4e6; color: #d9480f; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Centro de Tickets: <span id="tecnico-nombre"></span></h2>
        <div id="tabla-body">Cargando reportes...</div>
    </div>

    <script>
        // OFUSCACIÓN: Evita que el Webhook sea detectado fácilmente por bots
        const _base = "https://hook.us2.make.com/";
        const _path = "g2o6bagpnddob1127nhxqpwc7t6sdadx";

        const params = new URLSearchParams(window.location.search);
        const tecnico = params.get('nombre') || "Mtr. Gabriel Terrazas";
        document.getElementById('tecnico-nombre').innerText = tecnico;

        async function fetchTickets() {
            try {
                const res = await fetch(`${_base}${_path}?nombre=${encodeURIComponent(tecnico)}`);
                const csv = await res.text();
                renderTable(csv);
            } catch (e) {
                document.getElementById('tabla-body').innerHTML = "Error al conectar con el servidor.";
            }
        }

        function renderTable(csv) {
            const filas = csv.split('\n');
            if (filas.length <= 1) {
                document.getElementById('tabla-body').innerHTML = "No hay tickets asignados.";
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Usuario</th><th>Problema</th><th>Estado</th><th>Acción</th></tr></thead><tbody>';
            
            filas.forEach(f => {
                const c = f.split(',');
                if (c.length >= 10) {
                    const isConcluido = c[10].trim() === "Concluido";
                    html += `<tr>
                        <td><b>#${c[0]}</b></td>
                        <td>${c[6]}</td>
                        <td style="max-width:300px">${c[7]}</td>
                        <td><span class="badge ${isConcluido ? 'badge-concluido' : 'badge-revision'}">${c[10]}</span></td>
                        <td><a href="reporte.html?id=${c[0]}&user=${encodeURIComponent(c[6])}&nombre=${encodeURIComponent(tecnico)}" class="btn-resolver">${isConcluido ? 'Ver Detalle' : 'Resolver'}</a></td>
                    </tr>`;
                }
            });
            html += '</tbody></table>';
            document.getElementById('tabla-body').innerHTML = html;
        }
        fetchTickets();
    </script>
</body>
</html>
