<!DOCTYPE html>
<html lang="es">
<head>
    <script>
        // Bloqueo de seguridad: Si no hay sesión, fuera.
        if (sessionStorage.getItem('sesion_tic') !== 'activa') {
            window.location.href = 'index.html';
        }
    </script>
    <meta charset="UTF-8">
    <title>Historial de Tickets - SEDIF</title>
    <style>
        /* Tus estilos actuales de la tabla aquí */
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #00ad9f; color: white; }
        .estado-concluido { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Historial de: <span id="tecnico-nombre"></span></h2>
    <div id="tabla-container">Cargando datos...</div>

    <script>
        // Ofuscación básica de la URL del Webhook
        const _0x1 = "https://hook.us2.make.com/";
        const _0x2 = "g2o6bagpnddob1127nhxqpwc7t6sdadx";

        const urlParams = new URLSearchParams(window.location.search);
        const tecnico = urlParams.get('nombre') || "Mtr. Gabriel Terrazas";
        document.getElementById('tecnico-nombre').innerText = tecnico;

        async function cargarHistorial() {
            try {
                const response = await fetch(`${_0x1}${_0x2}?nombre=${encodeURIComponent(tecnico)}`);
                const data = await response.text();
                renderTabla(data);
            } catch (e) {
                document.getElementById('tabla-container').innerText = "Error al cargar datos.";
            }
        }

        function renderTabla(csv) {
            const filas = csv.split('\n');
            let html = '<table><tr><th>ID</th><th>Fecha</th><th>Usuario</th><th>Descripción</th><th>Estado</th></tr>';
            
            filas.forEach(fila => {
                const columnas = fila.split(',');
                if(columnas.length >= 4) {
                    html += `<tr>
                        <td>${columnas[0]}</td>
                        <td>${columnas[1]}</td>
                        <td>${columnas[6]}</td>
                        <td>${columnas[7]}</td>
                        <td class="${columnas[10] === 'Concluido' ? 'estado-concluido' : ''}">${columnas[10]}</td>
                    </tr>`;
                }
            });
            html += '</table>';
            document.getElementById('tabla-container').innerHTML = html;
        }

        cargarHistorial();
    </script>
</body>
</html>
