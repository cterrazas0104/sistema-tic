<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TIC</title>
    <style>
        :root { --primary: #00ad9f; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #f8f9fa; color: #666; text-transform: uppercase; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: top; }
        .btn-resolver { background: var(--primary); color: white; padding: 8px 15px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 12px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-concluido { background: #e6fcf5; color: #099268; }
        .badge-revision { background: #fff4e6; color: #d9480f; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Centro de Tickets: <span id="tecnico-nombre"></span></h2>
        <div id="tabla-body">Cargando reportes...</div>
    </div>

    <script>
        // Usamos el Webhook que YA TENÍAS para consultar el historial
        const webhookConsulta = "https://hook.us2.make.com/g2o6bagpnddob1127nhxqpwc7t6sdadx";

        // Obtenemos el nombre que viene desde el login de la Hoja 2
        const params = new URLSearchParams(window.location.search);
        const tecnico = params.get('nombre') || "Mtr. Gabriel Terrazas";
        document.getElementById('tecnico-nombre').innerText = tecnico;

        async function fetchTickets() {
            try {
                // Consultamos el historial con el nombre que validó el login
                const res = await fetch(`${webhookConsulta}?nombre=${encodeURIComponent(tecnico)}`);
                const csv = await res.text();
                
                // Si el CSV viene vacío o con error
                if (!csv || csv.includes("No se encontraron")) {
                    document.getElementById('tabla-body').innerHTML = "No hay tickets asignados para " + tecnico;
                    return;
                }
                renderTable(csv);
            } catch (e) {
                document.getElementById('tabla-body').innerHTML = "Error al conectar con el servidor.";
            }
        }

        function renderTable(csv) {
            const filas = csv.split('\n');
            let html = '<table><thead><tr><th>ID</th><th>Usuario</th><th>Problema</th><th>Estado</th><th>Acción</th></tr></thead><tbody>';
            
            let contador = 0;
            filas.forEach(f => {
                const c = f.split(',');
                // Verificamos que la fila tenga datos (mínimo el ID en c[0] y el Usuario en c[6])
                if (c.length >= 7 && c[0].trim() !== "") {
                    contador++;
                    const estado = (c[10] || "Sin atender").trim();
                    const isConcluido = estado === "Concluido" || estado === "Evaluado";
                    
                    html += `<tr>
                        <td><b>#${c[0]}</b></td>
                        <td>${c[6]}</td>
                        <td style="max-width:300px">${c[7] || 'Sin descripción'}</td>
                        <td><span class="badge ${isConcluido ? 'badge-concluido' : 'badge-revision'}">${estado}</span></td>
                        <td><a href="reporte.html?id=${c[0]}&user=${encodeURIComponent(c[6])}&nombre=${encodeURIComponent(tecnico)}" class="btn-resolver">${isConcluido ? 'Ver Detalle' : 'Resolver'}</a></td>
                    </tr>`;
                }
            });
            
            html += '</tbody></table>';
            
            if (contador === 0) {
                document.getElementById('tabla-body').innerHTML = "No hay tickets registrados en el historial.";
            } else {
                document.getElementById('tabla-body').innerHTML = html;
            }
        }
        fetchTickets();
    </script>
</body>
</html>
