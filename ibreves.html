<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidencias Ecala - SEDIF</title>
    <style>
        :root { --primary: #2c3e50; --accent: #00ad9f; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; display: flex; justify-content: center; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; font-size: 1.4em; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary); margin-top: 15px; font-size: 0.9em; }
        input, select, textarea, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1em; box-sizing: border-box; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .row input { flex: 1; }
        .btn-now { width: auto; background: #95a5a6; color: white; padding: 12px; font-size: 0.8em; margin-top: 0; cursor: pointer; border: none; font-weight: bold;}

        button#btn-enviar { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 25px; font-size: 1.1em; }
        button#btn-enviar:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #msg { display: none; text-align: center; color: #27ae60; font-weight: bold; margin-top: 15px; padding: 10px; border: 1px solid #27ae60; border-radius: 8px; background: #e6fcf5; }
        .req { color: #e74c3c; } /* Asterisco rojo para obligatorios */
        
        .back-link { display: block; text-align: center; margin-bottom: 20px; color: #7f8c8d; text-decoration: none; font-size: 0.9em; font-weight: bold; }
        .back-link:hover { color: var(--primary); }
    </style>
</head>
<body>
    <div class="card">
        <a href="#" id="link-volver" class="back-link">‚Üê Volver a Mi Panel</a>
        <h2>Nueva Incidencia Express</h2>
        
        <label>Fecha: <span class="req">*</span></label>
        <input type="date" id="fecha">

        <label>Hora Inicio: <span class="req">*</span></label>
        <div class="row">
            <input type="time" id="hora-inicio">
            <button type="button" class="btn-now" onclick="setHora('hora-inicio')">Ahora</button>
        </div>

        <label>Hora Fin: <span class="req">*</span></label>
        <div class="row">
            <input type="time" id="hora-fin">
            <button type="button" class="btn-now" onclick="setHora('hora-fin')">Ahora</button>
        </div>

        <label>Usuario / Solicitante: <span class="req">*</span></label>
        <input type="text" id="usuario" placeholder="¬øA qui√©n apoyaste?">
        
        <label>Correo del Usuario: <span class="req">*</span></label>
        <input type="email" id="correo" placeholder="ejemplo@queretaro.gob.mx" required>

        <label>√Årea:</label>
        <input type="text" id="area" placeholder="Ej: Adquisiciones, Finanzas...">

        <label>Descripci√≥n del Problema: <span class="req">*</span></label>
        <textarea id="problema" rows="2" placeholder="Ej: No imprime, equipo lento..."></textarea>

        <label>Descripci√≥n del Apoyo: <span class="req">*</span></label>
        <textarea id="apoyo" rows="2" placeholder="¬øQu√© soluci√≥n aplicaste?"></textarea>

        <label>Atendi√≥:</label>
        <select id="tecnico">
            <option value="Mtr. Gabriel Terrazas">Mtr. Gabriel Terrazas</option>
            <option value="Lic. Miguel Chavez">Lic. Miguel Chavez</option>
            <option value="Lic. Eduardo Perez">Lic. Eduardo Perez</option>
            <option value="Lic. Martin Alejandro Reyes Bocanegra">Lic. Alejandro Reyes</option>
            <option value="Fati">Fati</option>
            <option value="Lic. Luis Carlos">Lic. Luis Carlos</option>
        </select>

        <button id="btn-enviar" onclick="enviarIncidencia()">Guardar y Enviar Acuse</button>
        <p id="msg">‚úÖ Incidencia guardada y acuse enviado al usuario.</p>
    </div>

    <script>
        // --- Configurar Panel de Regreso y T√©cnico por Defecto ---
        const userRole = localStorage.getItem('userRole');
        const userName = localStorage.getItem('userName');
        const linkVolver = document.getElementById('link-volver');
        
        if (userRole === 'admin') { linkVolver.href = 'admin.html'; } 
        else if (userRole === 'tecnico') { linkVolver.href = 'tecnico.html'; }
        else { linkVolver.style.display = 'none'; }

        if (userName) {
            const selectTecnico = document.getElementById('tecnico');
            for(let i=0; i<selectTecnico.options.length; i++) {
                if(selectTecnico.options[i].value === userName || userName.includes(selectTecnico.options[i].value)) {
                    selectTecnico.selectedIndex = i;
                    break;
                }
            }
        }

        // Poner fecha de hoy por defecto
        document.getElementById('fecha').valueAsDate = new Date();

        function setHora(id) {
            const ahora = new Date();
            const horas = String(ahora.getHours()).padStart(2, '0');
            const minutos = String(ahora.getMinutes()).padStart(2, '0');
            document.getElementById(id).value = `${horas}:${minutos}`;
        }

        async function enviarIncidencia() {
            const btn = document.getElementById('btn-enviar');
            // üëá PEGA AQU√ç TU URL NUEVA DE APPS SCRIPT üëá
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxZhLFw530NGYRXyvdJLoMw0Y40VijyHqW0dwnkEv6Id68GiB__W77WEPYoaliusost/exec';
         
            const data = {
                accion: "guardar_ibreve", 
                fecha: document.getElementById('fecha').value,
                inicio: document.getElementById('hora-inicio').value,
                fin: document.getElementById('hora-fin').value,
                usuario: document.getElementById('usuario').value,
                correo: document.getElementById('correo').value,
                area: document.getElementById('area').value,
                problema: document.getElementById('problema').value,
                apoyo: document.getElementById('apoyo').value,
                tecnico: document.getElementById('tecnico').value
            };

            // VALIDACI√ìN ESTRICTA: AHORA EL CORREO ES OBLIGATORIO
            if(!data.usuario || !data.correo || !data.problema || !data.inicio || !data.apoyo) {
                alert("Por favor completa todos los campos obligatorios (*), incluyendo el Correo del Usuario.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Guardando y enviando correo...";

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                document.getElementById('msg').style.display = "block";
                
                // Limpiar formulario tras 2.5 segundos para nueva entrada
                setTimeout(() => { location.reload(); }, 2500);
                
            } catch (e) {
                alert("Error de conexi√≥n con el servidor.");
                btn.disabled = false;
                btn.innerText = "Guardar y Enviar Acuse";
            }
        }
    </script>
</body>
</html>
